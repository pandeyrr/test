name: Deploy HTML to OpenShift Sandbox

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # Step 1: Checkout code
      - name: Checkout repository
        uses: actions/checkout@v4

      # Step 2: Login to OpenShift
      - name: Login to OpenShift
        uses: redhat-actions/oc-login@v1
        with:
          openshift_server_url: ${{ secrets.OPENSHIFT_SERVER }}
          openshift_token: ${{ secrets.OPENSHIFT_TOKEN }}
          namespace: ${{ secrets.OPENSHIFT_NAMESPACE }}

      # Step 3: Deploy HTML
      - name: Deploy HTML
        run: |
          # 1. Create/update ConfigMap
          oc create configmap test-html --from-file=index.html --dry-run=client -o yaml | oc apply -f -

          # 2. Apply Deployment, Service, and Route inline
          printf "apiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: test\nspec:\n  replicas: 1\n  selector:\n    matchLabels:\n      app: test\n  template:\n    metadata:\n      labels:\n        app: test\n    spec:\n      containers:\n      - name: test\n        image: nginx:alpine\n        ports:\n        - containerPort: 80\n        volumeMounts:\n        - name: html\n          mountPath: /usr/share/nginx/html\n      volumes:\n      - name: html\n        configMap:\n          name: test-html\n---\napiVersion: v1\nkind: Service\nmetadata:\n  name: test\nspec:\n  selector:\n    app: test\n  ports:\n  - protocol: TCP\n    port: 80\n    targetPort: 80\n---\napiVersion: route.openshift.io/v1\nkind: Route\nmetadata:\n  name: test\nspec:\n  to:\n    kind: Service\n    name: test\n  port:\n    targetPort: 80" | oc apply -f -
